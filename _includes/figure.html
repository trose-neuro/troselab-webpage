<figure class="figure{% if include.boxed %} figure-boxed{% endif %}{% if include.class %} {{ include.class }}{% endif %}">
  {% assign figure_href = include.link | default: "" | strip %}
  {% assign figure_has_scheme = false %}
  {% assign figure_external = false %}
  {% assign figure_looks_like_domain = false %}
  {% if figure_href contains "mailto:" or figure_href contains "tel:" or figure_href contains "://" %}
    {% assign figure_has_scheme = true %}
  {% endif %}
  {% assign figure_prefix = figure_href | slice: 0, 4 %}
  {% assign figure_first_char = figure_href | slice: 0, 1 %}
  {% assign figure_head = figure_href | split: "/" | first | split: "?" | first | split: "#" | first %}
  {% if figure_has_scheme == false and figure_href != "" %}
    {% if figure_first_char != "/" and figure_first_char != "." and figure_first_char != "#" and figure_first_char != "?" %}
      {% if figure_head contains "." %}
        {% assign figure_looks_like_domain = true %}
      {% endif %}
    {% endif %}
  {% endif %}
  {% if figure_has_scheme == false %}
    {% if figure_prefix == "www." or figure_looks_like_domain %}
      {% assign figure_href = "https://" | append: figure_href %}
      {% assign figure_has_scheme = true %}
    {% endif %}
  {% endif %}
  {% if figure_href contains "http://" or figure_href contains "https://" %}
    {% assign figure_external = true %}
  {% endif %}
  <a
    {% if figure_href != "" %}
      {% if figure_has_scheme %}
        href="{{ figure_href }}"
      {% else %}
        href="{{ figure_href | relative_url | uri_escape }}"
      {% endif %}
      {% if figure_external %}
        target="_blank"
        rel="noopener noreferrer"
      {% endif %}
    {% endif %}
    class="figure-image"
    aria-label="{{ include.caption | default: "figure link" | regex_strip }}"
  >
    {% assign figure_sizes = "(max-width: 1200px) 96vw, 1100px" %}
    {% capture figure_style %}width: {{ include.width | default: "auto" }}; max-height: {{ include.height | default: "unset" }};{% endcapture %}
    {% assign figure_highres = include.data_highres | default: include.image %}
    {%
      include responsive-image.html
      image=include.image
      alt=include.caption
      sizes=figure_sizes
      loading="lazy"
      style=figure_style
      data_highres=figure_highres
    %}
  </a>
  {% if include.caption %}
    <figcaption class="figure-caption">
      {{ include.caption | markdownify | remove: "<p>" | remove: "</p>" }}
    </figcaption>
  {% endif %}
</figure>
